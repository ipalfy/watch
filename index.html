<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Braun-Style Analog Watch</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		/* This just for reference
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						customBlue: '#1e40af',
					},
				},
			},
		};
		*/
	</script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg-color-light: #f0f0f0;
			--bg-color-dark: #1a1a1a;
			--watch-face-light: #ffffff;
			--watch-face-dark: #2d2d2d;
			--text-color-light: #333333;
			--text-color-dark: #e0e0e0;
			--marker-color-light: #b0b0b0;
			--marker-color-dark: #555555;
			--marker-major-light: #000000;
			--marker-major-dark: #e0e0e0;
			--hand-hour-light: #bf0404;
			--hand-hour-dark: #e0e0e0;
			--hand-minute-light: #000000;
			--hand-minute-dark: #e0e0e0;
			--hand-second-color: #fdd835;
			/* Braun yellow */
			--chrono-hand-color: #d32f2f;
			/* Braun red */
			--case-shadow-light:
				-10px -10px 20px rgba(255, 255, 255, 0.7),
				10px 10px 20px rgba(0, 0, 0, 0.15),
				inset -2px -2px 4px rgba(0, 0, 0, 0.1),
				inset 2px 2px 4px rgba(255, 255, 255, 0.8);
			--case-shadow-dark:
				-8px -8px 15px rgba(45, 45, 45, 0.5),
				8px 8px 15px rgba(0, 0, 0, 0.3),
				inset -2px -2px 4px rgba(0, 0, 0, 0.5),
				inset 2px 2px 4px rgba(45, 45, 45, 0.4);
		}

		body {
			font-family: 'Inter', sans-serif;
			transition: background-color 0.3s ease;
		}

		.dark-mode {
			background-color: var(--bg-color-dark);
		}

		.light-mode {
			background-color: var(--bg-color-light);
		}

		.watch {
			width: 320px;
			height: 320px;
			box-shadow: var(--case-shadow-light);
		}

		.dark-mode .watch {
			box-shadow: var(--case-shadow-dark);
		}

		.watch-face {
			background-color: var(--watch-face-light);
			transition: background-color 0.3s ease;
			position: relative;
		}

		.watch-face::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			border-radius: 50%;
			background-image: var(--sun-moon-gradient);
			opacity: 0;
			transition: opacity 0.5s ease-in-out;
		}

		.watch-face.sun-moon-active::before {
			opacity: 1;
		}

		.dark-mode .watch-face {
			background-color: var(--watch-face-dark);
		}

		.marker-line {
			position: absolute;
			top: 0;
			left: 50%;
			transform: translateX(-50%);
			background-color: var(--marker-color-light);
			transition: background-color 0.3s ease;
		}

		.dark-mode .marker-line {
			background-color: var(--marker-color-dark);
		}

		.dark-mode .marker-line.major {
			background-color: var(--marker-major-dark);
		}

		.marker-line.major {
			background-color: var(--marker-major-light);
		}

		.hand {
			position: absolute;
			left: 50%;
			top: 50%;
			transform-origin: bottom;
			border-radius: 2px;
			z-index: 20;
		}

		.center-pivot {
			z-index: 25;
			background-color: var(--hand-second-color);
		}

		.hour-hand {
			width: 6px;
			height: 65px;
			background-color: var(--hand-hour-light);
			transition: background-color 0.3s ease, transform 0.5s ease-in-out;
		}

		.dark-mode .hour-hand {
			background-color: var(--hand-hour-dark);
		}

		.minute-hand {
			width: 4px;
			height: 100px;
			background-color: var(--hand-minute-light);
			transition: background-color 0.3s ease, transform 0.5s ease-in-out;
		}

		.dark-mode .minute-hand {
			background-color: var(--hand-minute-dark);
		}

		.second-hand {
			width: 2px;
			height: 110px;
			background-color: var(--hand-second-color);
		}

		.date-display {
			color: var(--text-color-light);
			transition: color 0.3s ease;
			z-index: 5;
		}

		.dark-mode .date-display {
			color: var(--text-color-dark);
		}

		.chrono-number {
			color: var(--text-color-light);
			transition: color 0.3s ease;
			z-index: 5;
		}

		.dark-mode .chrono-number {
			color: var(--text-color-dark);
		}

		.chrono-dial {
			width: 80px;
			height: 80px;
			top: 51px;
			border: 1px solid var(--marker-color-light);
			background-color: var(--watch-face-light);
			transition: background-color 0.3s ease, border-color 0.3s ease;
			z-index: 10;
		}

		.dark-mode .chrono-dial {
			border-color: var(--marker-color-dark);
			background-color: var(--watch-face-dark);
		}

		.chrono-hand {
			z-index: 11;
		}

		.watch-button {
			position: absolute;
			top: 50%;
			left: 50%;
			width: 40px;
			height: 16px;
			margin-top: -6px;
			/* half of height */
			background: linear-gradient(to bottom, #c0c0c0, #f0f0f0);
			border: 1px solid #a0a0a0;
			cursor: pointer;
			box-shadow: 0 2px 3px rgba(0, 0, 0, 0.3);
			transition: all 0.1s ease;
			transform-origin: 0 50%;
		}

		.watch-button:active {
			background: linear-gradient(to top, #c0c0c0, #f0f0f0);
			box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
		}

		.dark-mode .watch-button {
			background: linear-gradient(to bottom, #3a3a3a, #5a5a5a);
			border-color: #222;
		}

		#start-stop-button {
			transform: translate(138px, -104px) rotate(60deg);
		}

		#reset-button {
			transform: translate(170px, -20px) rotate(90deg);
		}

		#mode-toggle {
			transform: translate(138px, 100px) rotate(-60deg);
		}

		#time-mode-button {
			transform: translate(-157px, 67px) rotate(60deg);
		}

		.button-label {
			position: absolute;
			font-size: 10px;
			font-weight: 500;
			color: var(--marker-color-light);
			z-index: 15;
		}

		.dark-mode .button-label {
			color: var(--marker-color-dark);
		}

		#label-ss {
			top: 95px;
			right: 50px;
			transform: rotate(-30deg);
		}

		#label-rst {
			top: 145px;
			right: 35px;
		}

		#label-mode {
			top: 195px;
			right: 50px;
			transform: rotate(30deg);
		}

		#label-time-mode {
			top: 195px;
			left: 55px;
			transform: rotate(-30deg);
		}

		.hour-number {
			position: absolute;
			width: 30px;
			height: 30px;
			top: 50%;
			left: 50%;
			margin: -15px 0 0 -15px;
			text-align: center;
			line-height: 30px;
			font-size: 20px;
			font-weight: 500;
			color: var(--text-color-light);
			transition: color 0.3s ease, transform 0.5s ease-in-out, font-size 0.5s ease-in-out, opacity 0.5s ease-in-out;
		}

		.dark-mode .hour-number {
			color: var(--text-color-dark);
		}

		.button-label .active {
			color: #d32f2f;
			/* Braun red */
		}

		#sun-moon-toggle {
			transform: translate(-160px, -70px) rotate(-59deg);
		}

		#label-sun-moon {
			top: 100px;
			left: 58px;
			transform: rotate(30deg);
		}

		.sun-moon-symbol {
			position: absolute;
			width: 20px;
			height: 20px;
			top: 50%;
			left: 50%;
			margin: -10px 0 0 -10px;
			text-align: center;
			line-height: 20px;
			font-size: 14px;
			z-index: 15;
		}
	</style>
</head>

<body class="light-mode flex items-center justify-center min-h-screen">
	<div class="absolute top-4 left-4 z-50">
		<button id="menu-button" class="p-2 rounded-md bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200">
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
				xmlns="http://www.w3.org/2000/svg">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
			</svg>
		</button>
		<div id="menu" class="hidden absolute top-12 left-0 bg-white dark:bg-gray-900 rounded-md shadow-lg p-2 w-48">
			<a href="demos/grok-sunclock.html"
				class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"
				title="Sun status by Grok.">Grok
				sun status</a>
			<a href="demos/chrono-demo.html"
				class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"
				title="A lap timer created by Grok.">Grok
				Lap timer</a>
			<a href="demos/grok-calculator.html"
				class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"
				title="A calculator interface created by Grok.">Grok
				Calculator</a>
			<a href="demos/grok-clock.html"
				class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"
				title="A clock face created by Grok.">Grok
				Clock</a>
			<a href="demos/qwen-munich.html"
				class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"
				title="A Munich-style clock by Qwen.">Qwen
				Munich</a>
			<a href="demos/qwen-watch.html"
				class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md"
				title="A watch face by Qwen.">Qwen
				Watch</a>
		</div>
	</div>
	<script>
		const menuButton = document.getElementById('menu-button');
		const menu = document.getElementById('menu');

		menuButton.addEventListener('click', () => {
			menu.classList.toggle('hidden');
		});
	</script>
	<div id="watch" class="watch relative rounded-full flex items-center justify-center">

		<div class="watch-face absolute w-full h-full rounded-full border-8 border-gray-300 dark:border-gray-700">

			<!-- Sun/Moon Symbols -->
			<div id="sun-moon-symbols" style="display: none;"></div>

			<!-- Markers -->
			<div class="markers-container absolute w-full h-full z-0"></div>

			<!-- Numbers -->
			<div class="numbers-container absolute w-full h-full z-1"></div>

			<!-- Button Labels -->
			<div id="label-ss" class="button-label">
				<span id="label-start" class="active">Start</span> | <span id="label-stop">Stop</span>
			</div>
			<div id="label-rst" class="button-label">Reset</div>
			<div id="label-mode" class="button-label">
				<span id="label-light" class="active">Light</span> | <span id="label-dark">Dark</span>
			</div>
			<div id="label-time-mode" class="button-label">
				<span id="label-12h" class="active">12h</span> | <span id="label-24h">24h</span>
			</div>
			<div id="label-sun-moon" class="button-label">Sun/Moon</div>

			<!-- Hands -->
			<div class="hand hour-hand"></div>
			<div class="hand minute-hand"></div>
			<div class="hand second-hand"></div>
			<div class="center-pivot absolute w-4 h-4 dark:bg-white rounded-full top-1/2 left-1/2 -mt-2 -ml-2"></div>

			<!-- Date Display -->
			<div class="date-display absolute left-[120px] top-[210px] -mt-3 text-sm font-semibold text-center"></div>

			<!-- Digital Display -->
			<div
				class="digital-display absolute left-[40px] top-[150px] -mt-3 text-sm bg-red-600 text-white p-1 rounded text-center w-20">
			</div>

			<!-- Chronometer -->
			<div class="chrono-dial absolute left-1/2 -ml-10 rounded-full flex items-center justify-center">
				<div class="hand chrono-hand w-0.5 h-[30px] bg-red-600"></div>
				<div class="absolute w-2 h-2 bg-red-600 rounded-full top-1/2 left-1/2 -mt-1 -ml-1 z-10"></div>
				<div class="chrono-number absolute top-[45px] left-[10px] z-10 text-sm text-center"></div>
			</div>

			<!-- Buttons -->
			<button id="start-stop-button" class="watch-button"></button>
			<button id="reset-button" class="watch-button"></button>
			<button id="mode-toggle" class="watch-button"></button>
			<button id="time-mode-button" class="watch-button"></button>
			<button id="sun-moon-toggle" class="watch-button"></button>

		</div>

	</div>
	<script>
		// --- DOM Elements ---
		const body = document.body;
		const hourHand = document.querySelector('.hour-hand');
		const minuteHand = document.querySelector('.minute-hand');
		const secondHand = document.querySelector('.second-hand');
		const dateDisplay = document.querySelector('.date-display');
		const digitalDisplay = document.querySelector('.digital-display');
		const markersContainer = document.querySelector('.markers-container');
		const numbersContainer = document.querySelector('.numbers-container');
		const chronoHand = document.querySelector('.chrono-hand');
		const chronoNumber = document.querySelector('.chrono-number');

		const startStopButton = document.getElementById('start-stop-button');
		const resetButton = document.getElementById('reset-button');
		const modeToggleButton = document.getElementById('mode-toggle');
		const timeModeButton = document.getElementById('time-mode-button');
		const sunMoonToggleButton = document.getElementById('sun-moon-toggle');

		// --- State ---
		let chronoInterval = null;
		let chronoSeconds = 0;
		let isChronoRunning = false;
		let is24HourMode = false;
		let sunMoonData = null;
		let symbolsVisible = false;
		let timeModeBeforeSunMoon = null;

		// --- Create Markers ---
		function createMarkers() {
			markersContainer.innerHTML = ''; // Clear previous markers
			const markers = is24HourMode ? 24 : 60;
			const step = 360 / markers;

			for (let i = 0; i < markers; i++) {
				const rotation = i * step;
				const markerWrapper = document.createElement('div');
				markerWrapper.className = 'absolute w-full h-full';
				markerWrapper.style.transform = `rotate(${rotation}deg)`;

				const markerLine = document.createElement('div');
				markerLine.classList.add('marker-line');

				if (is24HourMode) {
					markerLine.style.width = '2px';
					markerLine.style.height = '10px';
					markerLine.classList.add('major');
				} else {
					if (i % 5 === 0) { // Hour marker
						markerLine.style.width = '3px';
						markerLine.style.height = '12px';
						markerLine.classList.add('major');
					} else { // Minute marker
						markerLine.style.width = '1px';
						markerLine.style.height = '6px';
					}
				}

				markerWrapper.appendChild(markerLine);
				markersContainer.appendChild(markerWrapper);
			}
		}

		// --- Create Hour Numbers ---
		function createHourNumbers() {
			const hours = is24HourMode ? 24 : 12;
			const step = 360 / hours;
			const radius = is24HourMode ? 130 : 125; // Reverted 12h radius
			const fontSize = is24HourMode ? '14px' : '20px';

			// Create a fragment to batch DOM insertions
			const fragment = document.createDocumentFragment();

			// Animate existing numbers and add new ones
			for (let i = 1; i <= 24; i++) {
				let numberEl = numbersContainer.querySelector(`.hour-number-${i}`);

				if (i <= hours) {
					let angle;
					if (is24HourMode) {
						angle = (i * step - 180) * (Math.PI / 180);
					} else {
						angle = i * step * (Math.PI / 180); // Original 12h angle
					}
					const x = Math.sin(angle) * radius;
					const y = -Math.cos(angle) * radius;

					if (!numberEl) {
						numberEl = document.createElement('div');
						numberEl.classList.add('hour-number', `hour-number-${i}`);
						numberEl.textContent = i;
						numberEl.style.opacity = '0'; // Start transparent
						fragment.appendChild(numberEl);
					}

					// Use a timeout to apply transition-triggering styles after element is in DOM
					setTimeout(() => {
						numberEl.style.fontSize = fontSize;
						numberEl.style.transform = `translate(${x}px, ${y}px)`;
						numberEl.style.opacity = '1';
					}, 10);

				} else {
					if (numberEl) {
						numberEl.style.opacity = '0';
						setTimeout(() => {
							numberEl.remove();
						}, 500); // Remove after fade out
					}
				}
			}
			numbersContainer.appendChild(fragment);
		}

		// --- Update Clock and Date ---
		function setDate() {
			const now = new Date();

			const seconds = now.getSeconds();
			const secondsDegrees = (seconds / 60) * 360;
			secondHand.style.transform = `translate(-50%, -100%) rotate(${secondsDegrees}deg)`;

			const minutes = now.getMinutes();
			const minutesDegrees = (minutes / 60) * 360 + (seconds / 60) * 6;
			minuteHand.style.transform = `translate(-50%, -100%) rotate(${minutesDegrees}deg)`;

			const hours = now.getHours();
			let hoursDegrees;
			if (is24HourMode) {
				hoursDegrees = (hours / 24) * 360 + (minutes / 60) * 15 - 180;
			} else {
				hoursDegrees = (hours / 12) * 360 + (minutes / 60) * 30;
			}
			hourHand.style.transform = `translate(-50%, -100%) rotate(${hoursDegrees}deg)`;

			const day = String(now.getDate()).padStart(2, '0');
			const dayOfWeek = now.toLocaleDateString(undefined, { weekday: 'long' });
			const monthName = now.toLocaleDateString(undefined, { month: 'long' });
			const month = String(now.getMonth() + 1).padStart(2, '0');

			digitalDisplay.textContent = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
			dateDisplay.innerHTML = `${dayOfWeek}<br>${day}.${month} ${now.getFullYear()}`;
		}

		// --- Chronometer Logic ---
		function handleStartStop() {
			if (isChronoRunning) {
				clearInterval(chronoInterval);
				isChronoRunning = false;
				localStorage.setItem('chrono-running', 'false');
				localStorage.setItem('chrono-seconds', chronoSeconds);
				localStorage.removeItem('chrono-startTime');
			} else {
				const startTime = Date.now() - (chronoSeconds * 1000);
				localStorage.setItem('chrono-startTime', startTime);
				localStorage.setItem('chrono-running', 'true');
				localStorage.removeItem('chrono-seconds');
				chronoInterval = setInterval(() => {
					chronoSeconds = (Date.now() - startTime) / 1000;
					const chronoDegrees = ((chronoSeconds % 60) / 60) * 360;
					chronoHand.style.transform = `translate(-50%, -100%) rotate(${chronoDegrees}deg)`;
					chronoNumber.textContent = formatSeconds(chronoSeconds);
				}, 50);
				isChronoRunning = true;
			}
			document.getElementById('label-stop').classList.toggle('active', isChronoRunning);
			document.getElementById('label-start').classList.toggle('active', !isChronoRunning);
		}

		function handleReset() {
			clearInterval(chronoInterval);
			isChronoRunning = false;
			chronoSeconds = 0;
			chronoNumber.textContent = '';
			chronoHand.style.transform = 'translate(-50%, -100%) rotate(0deg)';
			document.getElementById('label-stop').classList.remove('active');
			document.getElementById('label-start').classList.add('active');
			localStorage.removeItem('chrono-running');
			localStorage.removeItem('chrono-seconds');
			localStorage.removeItem('chrono-startTime');
		}

		function formatSeconds(seconds) {
			const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
			const wholeSeconds = Math.floor(seconds % 60).toString().padStart(2, '0');
			const secondFraction = (seconds % 1).toFixed(2).slice(2).padStart(2, '0');
			return `${minutes}:${wholeSeconds}:${secondFraction}`;
		}

		function normalizeDeg(deg) {
			return (deg % 360 + 360) % 360;
		}

		function updateWatchFaceGradient() {
			const watchFace = document.querySelector('.watch-face');
			if (!sunMoonData) {
				watchFace.style.setProperty('--sun-moon-gradient', 'none');
				return;
			}

			const sunriseDeg = timeToDegrees(sunMoonData.sunrise);
			const sunsetDeg = timeToDegrees(sunMoonData.sunset);

			const sunriseNorm = normalizeDeg(sunriseDeg);
			const sunsetNorm = normalizeDeg(sunsetDeg);

			const isDarkMode = body.classList.contains('dark-mode');
			const dayColor = isDarkMode ? 'var(--watch-face-dark)' : 'var(--watch-face-light)';
			const nightEdgeColor = isDarkMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.05)';
			const nightDarkColor = isDarkMode ? 'rgba(0, 0, 0, 0.2)' : 'rgba(0, 0, 0, 0.1)';

			let nightDurDeg = normalizeDeg(sunriseNorm - sunsetNorm);
			if (nightDurDeg === 0) nightDurDeg = 360;

			const gradient = `conic-gradient(from ${sunsetNorm}deg, ${nightEdgeColor} 0deg, ${nightDarkColor} 15deg, ${nightDarkColor} ${nightDurDeg - 15}deg, ${nightEdgeColor} ${nightDurDeg}deg, ${dayColor} ${nightDurDeg}deg, ${dayColor} 360deg)`;
			watchFace.style.setProperty('--sun-moon-gradient', gradient);
		}

		function timeToDegrees(date) {
			const hours = date.getHours();
			const minutes = date.getMinutes();
			return (hours * 15) + (minutes / 60 * 15) - 180;
		}

		function createSunMoonSymbols(data) {
			const container = document.getElementById('sun-moon-symbols');
			container.innerHTML = ''; // Clear existing symbols
			if (!is24HourMode) return;

			const radius = 105;

			// Sunrise
			const sunriseAngle = timeToDegrees(data.sunrise);
			const sunriseSymbol = document.createElement('div');
			sunriseSymbol.className = 'sun-moon-symbol';
			const sunriseX = Math.sin(sunriseAngle * Math.PI / 180) * radius;
			const sunriseY = -Math.cos(sunriseAngle * Math.PI / 180) * radius;
			sunriseSymbol.style.transform = `translate(${sunriseX}px, ${sunriseY}px)`;
			sunriseSymbol.innerHTML = 'üåÖ';
			container.appendChild(sunriseSymbol);

			// Sunset
			const sunsetAngle = timeToDegrees(data.sunset);
			const sunsetSymbol = document.createElement('div');
			sunsetSymbol.className = 'sun-moon-symbol';
			const sunsetX = Math.sin(sunsetAngle * Math.PI / 180) * radius;
			const sunsetY = -Math.cos(sunsetAngle * Math.PI / 180) * radius;
			sunsetSymbol.style.transform = `translate(${sunsetX}px, ${sunsetY}px)`;
			sunsetSymbol.innerHTML = 'üåá';
			container.appendChild(sunsetSymbol);

			// Solar Noon
			const solarNoonAngle = timeToDegrees(data.solarNoon);
			const solarNoonSymbol = document.createElement('div');
			solarNoonSymbol.className = 'sun-moon-symbol';
			const solarNoonX = Math.sin(solarNoonAngle * Math.PI / 180) * radius;
			const solarNoonY = -Math.cos(solarNoonAngle * Math.PI / 180) * radius;
			solarNoonSymbol.style.transform = `translate(${solarNoonX}px, ${solarNoonY}px)`;
			solarNoonSymbol.innerHTML = '‚òÄÔ∏è';
			container.appendChild(solarNoonSymbol);

			// Moon Phase
			const moonIllumination = SunCalc.getMoonIllumination(new Date());
			const moonPhase = moonIllumination.phase;
			const moonPhaseSymbol = document.createElement('div');
			moonPhaseSymbol.className = 'sun-moon-symbol';
			const moonX = 0;
			const moonY = 105;
			moonPhaseSymbol.style.transform = `translate(${moonX}px, ${moonY}px)`;

			let moonIcon;
			if (moonPhase < 0.125) moonIcon = 'üåë';
			else if (moonPhase < 0.375) moonIcon = 'üåí';
			else if (moonPhase < 0.625) moonIcon = 'üåì';
			else if (moonPhase < 0.875) moonIcon = 'üåî';
			else moonIcon = 'üåï';

			moonPhaseSymbol.innerHTML = `<div style="color: darkblue;">${moonIcon}</div>`;
			container.appendChild(moonPhaseSymbol);
		}

		function fetchSunData(lat, lng) {
			sunMoonData = SunCalc.getTimes(new Date(), lat, lng);
			if (symbolsVisible) {
				createSunMoonSymbols(sunMoonData);
				updateWatchFaceGradient();
			}
		}

		function getFallbackLocation() {
			// Default to Munich
			fetchSunData(48.1374, 11.5755);
		}

		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						fetchSunData(position.coords.latitude, position.coords.longitude);
					},
					(error) => {
						getFallbackLocation();
					}
				);
			} else {
				getFallbackLocation();
			}
		}

		function updateSunMoonLabel() {
			const label = document.getElementById('label-sun-moon');
			if (symbolsVisible && is24HourMode) {
				label.classList.add('active');
			} else {
				label.classList.remove('active');
			}
		}

		function toggleSunMoonSymbols() {
			symbolsVisible = !symbolsVisible;

			if (symbolsVisible) { // Activating
				if (!is24HourMode) {
					timeModeBeforeSunMoon = '12h';
					toggleTimeMode();
				} else {
					const container = document.getElementById('sun-moon-symbols');
					if (sunMoonData) {
						createSunMoonSymbols(sunMoonData);
						updateWatchFaceGradient();
					} else {
						getLocation();
					}
					container.style.display = 'block';
					document.querySelector('.watch-face').classList.add('sun-moon-active');
				}
			} else { // Deactivating
				document.getElementById('sun-moon-symbols').style.display = 'none';
				document.querySelector('.watch-face').classList.remove('sun-moon-active');
				if (timeModeBeforeSunMoon === '12h') {
					toggleTimeMode();
					timeModeBeforeSunMoon = null;
				}
			}
			updateSunMoonLabel();
		}


		// --- Mode Toggles ---
		function toggleMode() {
			body.classList.toggle('dark-mode');
			body.classList.toggle('light-mode');
			const isDarkMode = body.classList.contains('dark-mode');
			document.getElementById('label-dark').classList.toggle('active', isDarkMode);
			document.getElementById('label-light').classList.toggle('active', !isDarkMode);
			localStorage.setItem('watch-theme', isDarkMode ? 'dark' : 'light');
			updateWatchFaceGradient();
		}

		function toggleTimeMode() {
			is24HourMode = !is24HourMode;
			const watchFace = document.querySelector('.watch-face');

			if (!is24HourMode) {
				document.getElementById('sun-moon-symbols').style.display = 'none';
				watchFace.classList.remove('sun-moon-active'); // Ensure gradient is off in 12h mode
			} else {
				if (symbolsVisible) {
					document.getElementById('sun-moon-symbols').style.display = 'block';
					if (!sunMoonData) {
						getLocation();
					} else {
						createSunMoonSymbols(sunMoonData);
						updateWatchFaceGradient();
					}
					watchFace.classList.add('sun-moon-active'); // Ensure gradient is on in 24h mode if symbols are visible
				}
			}
			updateSunMoonLabel();
			localStorage.setItem('watch-time-mode', is24HourMode ? '24h' : '12h');
			document.getElementById('label-24h').classList.toggle('active', is24HourMode);
			document.getElementById('label-12h').classList.toggle('active', !is24HourMode);

			// Animate markers
			markersContainer.style.transition = 'opacity 0.25s ease-out';
			markersContainer.style.opacity = '0';
			setTimeout(() => {
				createMarkers();
				markersContainer.style.transition = 'opacity 0.25s ease-in';
				markersContainer.style.opacity = '1';
			}, 250);

			createHourNumbers();
			setDate();
		}

		// --- Load Preferences ---
		function loadTheme() {
			const savedTheme = localStorage.getItem('watch-theme');
			const isDarkMode = savedTheme === 'dark';
			body.classList.toggle('dark-mode', isDarkMode);
			body.classList.toggle('light-mode', !isDarkMode);
			document.getElementById('label-dark').classList.toggle('active', isDarkMode);
			document.getElementById('label-light').classList.toggle('active', !isDarkMode);
		}

		function loadTimeMode() {
			const savedTimeMode = localStorage.getItem('watch-time-mode');
			is24HourMode = savedTimeMode === '24h';
			document.getElementById('label-24h').classList.toggle('active', is24HourMode);
			document.getElementById('label-12h').classList.toggle('active', !is24HourMode);
		}

		function loadChronoState() {
			const wasRunning = localStorage.getItem('chrono-running') === 'true';
			if (wasRunning) {
				const startTime = parseInt(localStorage.getItem('chrono-startTime'), 10);
				if (startTime) {
					chronoSeconds = (Date.now() - startTime) / 1000;
					handleStartStop();
				}
			} else {
				chronoSeconds = parseFloat(localStorage.getItem('chrono-seconds')) || 0;
				if (chronoSeconds > 0) {
					const chronoDegrees = ((chronoSeconds % 60) / 60) * 360;
					chronoHand.style.transform = `translate(-50%, -100%) rotate(${chronoDegrees}deg)`;
					chronoNumber.textContent = formatSeconds(chronoSeconds);
				}
			}
		}

		// --- Event Listeners ---
		startStopButton.addEventListener('click', handleStartStop);
		resetButton.addEventListener('click', handleReset);
		modeToggleButton.addEventListener('click', toggleMode);
		timeModeButton.addEventListener('click', toggleTimeMode);
		sunMoonToggleButton.addEventListener('click', toggleSunMoonSymbols);

		// --- Initialization ---
		document.getElementById('label-start').classList.add('active');
		loadTheme();
		loadTimeMode();
		createMarkers();
		createHourNumbers();
		setDate();
		setInterval(setDate, 1000);
		loadChronoState();
		getLocation();

	</script>
</body>

</html>
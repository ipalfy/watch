<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Braun-Style Analog Watch</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div id="watch" class="watch">

		<div class="watch-face">

			<!-- Sun/Moon Symbols -->
			<div id="sun-moon-symbols" style="display: none;"></div>

			<!-- Markers -->
			<div class="markers-container"></div>

			<!-- Numbers -->
			<div class="numbers-container"></div>

			<!-- Button Labels -->
			<div id="label-ss" class="button-label">
				<span id="label-start" class="active">Start</span> |
				<span id="label-lap">Lap</span>
			</div>

			<div id="label-rst" class="button-label">
				<span id="label-stop">Stop</span> |
				<span id="label-reset">Reset</span>
			</div>

			<div id="label-mode" class="button-label">
				<span id="label-light" class="active">Light</span> |
				<span id="label-dark">Dark</span>
			</div>

			<div id="label-time-mode" class="button-label">
				<span id="label-12h" class="active">12h</span> |
				<span id="label-24h">24h</span>
			</div>

			<div id="label-sun-moon" class="button-label">Sun/Moon</div>

			<!-- Hands -->
			<div class="hand hour-hand"></div>
			<div class="hand minute-hand"></div>
			<div class="hand second-hand"></div>
			<div class="center-pivot"></div>

			<!-- Date Display -->
			<div class="date-display"></div>

			<!-- Digital Display -->
			<div class="digital-display"></div>
			<!-- Chronometer -->
			<div class="chrono-dial">
				<div class="hand chrono-hand"></div>
				<div class="chrono-pivot"></div>
				<div class="chrono-number"></div>
			</div>

			<!-- Buttons -->
			<button id="start-stop-button" class="watch-button"></button>
			<button id="reset-button" class="watch-button"></button>
			<button id="mode-toggle" class="watch-button"></button>
			<button id="time-mode-button" class="watch-button"></button>
			<button id="sun-moon-toggle" class="watch-button"></button>

		</div>

	</div>
	<div class="debug-controls" style="display: none;">
		<div id="map" style="height: 200px; width: 100%;"></div>
		<div class="debug-row">
			<label for="date-slider">Date</label>
			<span id="date-value" class="debug-value"></span>
		</div>
		<input type="range" id="date-slider" min="0" max="364" value="0" step="1">
		<button id="reset-debug-button">Reset to Current Position and Date/Time</button>
		<div id="location-display"></div>
	</div>
	<script>
		// --- DOM Elements ---
		const body = document.body;
		const hourHand = document.querySelector('.hour-hand');
		const minuteHand = document.querySelector('.minute-hand');
		const secondHand = document.querySelector('.second-hand');
		const dateDisplay = document.querySelector('.date-display');
		const digitalDisplay = document.querySelector('.digital-display');
		const markersContainer = document.querySelector('.markers-container');
		const numbersContainer = document.querySelector('.numbers-container');
		const chronoHand = document.querySelector('.chrono-hand');
		const chronoNumber = document.querySelector('.chrono-number');

		const startStopButton = document.getElementById('start-stop-button');
		const resetButton = document.getElementById('reset-button');
		const modeToggleButton = document.getElementById('mode-toggle');
		const timeModeButton = document.getElementById('time-mode-button');
		const sunMoonToggleButton = document.getElementById('sun-moon-toggle');

		const dateSlider = document.getElementById('date-slider');
		const dateValue = document.getElementById('date-value');
		const resetDebugButton = document.getElementById('reset-debug-button');
		const locationDisplay = document.getElementById('location-display');
		const mapContainer = document.getElementById('map');

		// --- Map State ---
		let map = null;
		let marker = null;
		let initialCoords = [48.1374, 11.5755]; // Default to Munich

		// --- Debounce Function ---
		function debounce(func, delay) {
			let timeout;
			return function(...args) {
				clearTimeout(timeout);
				timeout = setTimeout(() => func.apply(this, args), delay);
			};
		}

		// --- Location Fetching ---
		async function fetchLocationName(lat, lng) {
			locationDisplay.textContent = 'Resolving location...';
			try {
				const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				const data = await response.json();
				if (data && data.display_name) {
					locationDisplay.textContent = data.display_name;
				} else {
					locationDisplay.textContent = 'Location not found';
				}
			} catch (error) {
				locationDisplay.textContent = 'Could not resolve location';
				console.error('Error fetching location:', error);
			}
		}

		const debouncedFetchLocation = debounce(fetchLocationName, 500); // 500ms delay

		// --- State ---
		let chronoInterval = null;
		let chronoSeconds = 0;
		let isChronoRunning = false;
		let lapTimes = [];
		let is24HourMode = false;
		let sunMoonData = null;
		let symbolsVisible = false;
		let timeModeBeforeSunMoon = null;
		let debugDateOffset = 0; // in days

		function getCurrentDate() {
			const now = new Date();
			now.setDate(now.getDate() + debugDateOffset);
			return now;
		}

		function resetToNow() {
			debugDateOffset = 0;
			const today = new Date();
			const startOfYear = new Date(today.getFullYear(), 0, 1);
			const dayOfYear = Math.floor((today - startOfYear) / (1000 * 60 * 60 * 24));
			dateSlider.value = dayOfYear;
			dateValue.textContent = today.toLocaleDateString();
			
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						updateMapAndLocation(position.coords.latitude, position.coords.longitude, true);
					},
					() => {
						updateMapAndLocation(initialCoords[0], initialCoords[1], true);
					}
				);
			} else {
				updateMapAndLocation(initialCoords[0], initialCoords[1], true);
			}
			setDate();
		}

		// --- Map Functions ---
		function initMap(lat, lng) {
			if (map) {
				map.remove();
			}
			map = L.map(mapContainer).setView([lat, lng], 2);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			marker = L.marker([lat, lng]).addTo(map);

			map.on('click', function(e) {
				updateMapAndLocation(e.latlng.lat, e.latlng.lng, false);
			});
		}

		function updateMapAndLocation(lat, lng, resetView) {
			if (marker) {
				marker.setLatLng([lat, lng]);
			}
			if (map) {
				map.setView([lat, lng], resetView ? 2 : 5);
			}
			fetchSunData(lat, lng);
			debouncedFetchLocation(lat, lng);
		}


		// --- Create Markers ---
		function createMarkers() {
			markersContainer.innerHTML = ''; // Clear previous markers
			const markers = is24HourMode ? 24 : 60;
			const step = 360 / markers;

			for (let i = 0; i < markers; i++) {
				const rotation = i * step;
				const markerWrapper = document.createElement('div');
				markerWrapper.className = 'marker-wrapper';
				markerWrapper.style.transform = `rotate(${rotation}deg)`;

				const markerLine = document.createElement('div');
				markerLine.classList.add('marker-line');

				if (is24HourMode) {
					markerLine.style.width = '2px';
					markerLine.style.height = '10px';
					markerLine.classList.add('major');
				} else {
					if (i % 5 === 0) { // Hour marker
						markerLine.style.width = '3px';
						markerLine.style.height = '12px';
						markerLine.classList.add('major');
					} else { // Minute marker
						markerLine.style.width = '1px';
						markerLine.style.height = '6px';
					}
				}

				markerWrapper.appendChild(markerLine);
				markersContainer.appendChild(markerWrapper);
			}
		}

		function createChronoMarkers() {
			const chronoDial = document.querySelector('.chrono-dial');
			const markers = 60;
			const step = 360 / markers;

			for (let i = 0; i < markers; i++) {
				const rotation = i * step;
				const markerWrapper = document.createElement('div');
				markerWrapper.className = 'marker-wrapper';
				markerWrapper.style.transform = `rotate(${rotation}deg)`;

				const markerLine = document.createElement('div');
				markerLine.classList.add('marker-line');

				if (i % 5 === 0) { // Every 5 seconds
					markerLine.style.width = '2px';
					markerLine.style.height = '6px';
					markerLine.classList.add('major');
				}

				markerWrapper.appendChild(markerLine);
				chronoDial.appendChild(markerWrapper);
			}
		}

		// --- Create Hour Numbers ---
		function createHourNumbers() {
			const hours = is24HourMode ? 24 : 12;
			const step = 360 / hours;
			const radius = is24HourMode ? 130 : 125; // Reverted 12h radius
			const fontSize = is24HourMode ? '14px' : '20px';

			const fragment = document.createDocumentFragment();

			for (let i = 1; i <= 24; i++) {
				let numberEl = numbersContainer.querySelector(`.hour-number-${i}`);

				if (i <= hours) {
					let angle;
					if (is24HourMode) {
						angle = (i * step - 180) * (Math.PI / 180);
					} else {
						angle = i * step * (Math.PI / 180); // Original 12h angle
					}
					const x = Math.sin(angle) * radius;
					const y = -Math.cos(angle) * radius;

					if (!numberEl) {
						numberEl = document.createElement('div');
						numberEl.classList.add('hour-number', `hour-number-${i}`);
						numberEl.textContent = i;
						numberEl.style.opacity = '0'; // Start transparent
						fragment.appendChild(numberEl);
					}

					setTimeout(() => {
						numberEl.style.fontSize = fontSize;
						numberEl.style.transform = `translate(${x}px, ${y}px)`;
						numberEl.style.opacity = '1';
					}, 10);

				} else {
					if (numberEl) {
						numberEl.style.opacity = '0';
						setTimeout(() => {
							numberEl.remove();
						}, 500); // Remove after fade out
					}
				}
			}
			numbersContainer.appendChild(fragment);
		}

		// --- Update Clock and Date ---
		function setDate() {
			const now = getCurrentDate();

			const seconds = now.getSeconds();
			const secondsDegrees = (seconds / 60) * 360;
			secondHand.style.transform = `translate(-50%, -100%) rotate(${secondsDegrees}deg)`;

			const minutes = now.getMinutes();
			const minutesDegrees = (minutes / 60) * 360 + (seconds / 60) * 6;
			minuteHand.style.transform = `translate(-50%, -100%) rotate(${minutesDegrees}deg)`;

			const hours = now.getHours();
			let hoursDegrees;
			if (is24HourMode) {
				hoursDegrees = (hours / 24) * 360 + (minutes / 60) * 15 - 180;
			} else {
				hoursDegrees = (hours / 12) * 360 + (minutes / 60) * 30;
			}
			hourHand.style.transform = `translate(-50%, -100%) rotate(${hoursDegrees}deg)`;

			const day = String(now.getDate()).padStart(2, '0');
			const dayOfWeek = now.toLocaleDateString(undefined, { weekday: 'long' });
			const month = String(now.getMonth() + 1).padStart(2, '0');
			const year = String(now.getFullYear()).slice(-2);

			digitalDisplay.textContent = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
			dateDisplay.innerHTML = `${dayOfWeek}<br>${day}.${month}.${year}`;
		}

		// --- Chronometer Logic ---
		function handleStartLap() {
			if (!isChronoRunning) {
				isChronoRunning = true;
				const startTime = Date.now() - (chronoSeconds * 1000);
				localStorage.setItem('chrono-startTime', startTime);
				localStorage.setItem('chrono-running', 'true');
				localStorage.removeItem('chrono-seconds');
				chronoInterval = setInterval(() => {
					chronoSeconds = (Date.now() - startTime) / 1000;
					const chronoDegrees = ((chronoSeconds % 60) / 60) * 360;
					chronoHand.style.transform = `translate(-50%, -100%) rotate(${chronoDegrees}deg)`;
					chronoNumber.textContent = formatSeconds(chronoSeconds);
				}, 50);
			} else {
				const lapTime = chronoSeconds;
				lapTimes.push(lapTime);
				const lapHand = document.createElement('div');
				lapHand.className = 'hand lap-hand';
				lapHand.style.backgroundColor = 'black';
				lapHand.style.width = '2px';
				lapHand.style.height = '35px';
				const chronoDegrees = ((lapTime % 60) / 60) * 360;
				lapHand.style.transform = `translate(-50%, -100%) rotate(${chronoDegrees}deg)`;
				document.querySelector('.chrono-dial').appendChild(lapHand);
			}
			updateChronoLabels();
		}

		function handleStopReset() {
			if (isChronoRunning) {
				isChronoRunning = false;
				clearInterval(chronoInterval);
				localStorage.setItem('chrono-running', 'false');
				localStorage.setItem('chrono-seconds', chronoSeconds);
				localStorage.removeItem('chrono-startTime');
			} else {
				if (lapTimes.length > 0) {
					const lastLapTime = lapTimes.pop();
					chronoSeconds = lastLapTime;
					const chronoDegrees = ((chronoSeconds % 60) / 60) * 360;
					chronoHand.style.transform = `translate(-50%, -100%) rotate(${chronoDegrees}deg)`;
					chronoNumber.textContent = formatSeconds(chronoSeconds);

					const lapHands = document.querySelectorAll('.lap-hand');
					if (lapHands.length > 0) {
						lapHands[lapHands.length - 1].remove();
					}
					localStorage.setItem('chrono-seconds', chronoSeconds);
				} else {
					chronoSeconds = 0;
					lapTimes = [];
					chronoNumber.textContent = '';
					chronoHand.style.transform = 'translate(-50%, -100%) rotate(0deg)';
					const lapHands = document.querySelectorAll('.lap-hand');
					lapHands.forEach(hand => hand.remove());
					localStorage.removeItem('chrono-running');
					localStorage.removeItem('chrono-seconds');
					localStorage.removeItem('chrono-startTime');
				}
			}
			updateChronoLabels();
		}

		function updateChronoLabels() {
			document.getElementById('label-start').classList.toggle('active', !isChronoRunning);
			document.getElementById('label-lap').classList.toggle('active', isChronoRunning);
			document.getElementById('label-stop').classList.toggle('active', isChronoRunning);
			document.getElementById('label-reset').classList.toggle('active', !isChronoRunning && chronoSeconds > 0);
		}

		function formatSeconds(seconds) {
			const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
			const wholeSeconds = Math.floor(seconds % 60).toString().padStart(2, '0');
			const secondFraction = (seconds % 1).toFixed(2).slice(2).padStart(2, '0');
			return `${minutes}:${wholeSeconds}:${secondFraction}`;
		}

		function normalizeDeg(deg) {
			return (deg % 360 + 360) % 360;
		}

		function updateWatchFaceGradient() {
			const watchFace = document.querySelector('.watch-face');
			if (!sunMoonData) {
				watchFace.style.setProperty('--sun-moon-gradient', 'none');
				return;
			}

			const sunriseDeg = timeToDegrees(sunMoonData.sunrise);
			const sunsetDeg = timeToDegrees(sunMoonData.sunset);

			const sunriseNorm = normalizeDeg(sunriseDeg);
			const sunsetNorm = normalizeDeg(sunsetDeg);

			const isDarkMode = body.classList.contains('dark-mode');
			const dayColor = isDarkMode ? 'var(--watch-face-dark)' : 'var(--watch-face-light)';
			const nightEdgeColor = isDarkMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.05)';
			const nightDarkColor = isDarkMode ? 'rgba(0, 0, 0, 0.2)' : 'rgba(0, 0, 0, 0.1)';

			let nightDurDeg = normalizeDeg(sunriseNorm - sunsetNorm);
			if (nightDurDeg === 0) nightDurDeg = 360;

			const gradient = `conic-gradient(from ${sunsetNorm}deg, ${nightEdgeColor} 0deg, ${nightDarkColor} 15deg, ${nightDarkColor} ${nightDurDeg - 15}deg, ${nightEdgeColor} ${nightDurDeg}deg, ${dayColor} ${nightDurDeg}deg, ${dayColor} 360deg)`;
			watchFace.style.setProperty('--sun-moon-gradient', gradient);
		}

		function timeToDegrees(date) {
			const hours = date.getHours();
			const minutes = date.getMinutes();
			return (hours * 15) + (minutes / 60 * 15) - 180;
		}

		function createSunMoonSymbols(data) {
			const container = document.getElementById('sun-moon-symbols');
			container.innerHTML = ''; // Clear existing symbols
			if (!is24HourMode) return;

			const radius = 105;

			// Sunrise
			const sunriseAngle = timeToDegrees(data.sunrise);
			const sunriseSymbol = document.createElement('div');
			sunriseSymbol.className = 'sun-moon-symbol';
			const sunriseX = Math.sin(sunriseAngle * Math.PI / 180) * radius;
			const sunriseY = -Math.cos(sunriseAngle * Math.PI / 180) * radius;
			sunriseSymbol.style.transform = `translate(${sunriseX}px, ${sunriseY}px)`;
			sunriseSymbol.innerHTML = 'üåÖ';
			container.appendChild(sunriseSymbol);

			// Sunset
			const sunsetAngle = timeToDegrees(data.sunset);
			const sunsetSymbol = document.createElement('div');
			sunsetSymbol.className = 'sun-moon-symbol';
			const sunsetX = Math.sin(sunsetAngle * Math.PI / 180) * radius;
			const sunsetY = -Math.cos(sunsetAngle * Math.PI / 180) * radius;
			sunsetSymbol.style.transform = `translate(${sunsetX}px, ${sunsetY}px)`;
			sunsetSymbol.innerHTML = 'üåá';
			container.appendChild(sunsetSymbol);

			// Solar Noon
			const solarNoonAngle = timeToDegrees(data.solarNoon);
			const solarNoonSymbol = document.createElement('div');
			solarNoonSymbol.className = 'sun-moon-symbol';
			const solarNoonX = Math.sin(solarNoonAngle * Math.PI / 180) * radius;
			const solarNoonY = -Math.cos(solarNoonAngle * Math.PI / 180) * radius;
			solarNoonSymbol.style.transform = `translate(${solarNoonX}px, ${solarNoonY}px)`;
			solarNoonSymbol.innerHTML = '‚òÄÔ∏è';
			container.appendChild(solarNoonSymbol);

			// Moon Phase
			const moonIllumination = SunCalc.getMoonIllumination(getCurrentDate());
			const moonPhase = moonIllumination.phase;
			const moonPhaseSymbol = document.createElement('div');
			moonPhaseSymbol.className = 'sun-moon-symbol';
			const moonX = 0;
			const moonY = 105;
			moonPhaseSymbol.style.transform = `translate(${moonX}px, ${moonY}px)`;

			let moonIcon;
			if (moonPhase < 0.125) moonIcon = 'üåë';
			else if (moonPhase < 0.375) moonIcon = 'üåí';
			else if (moonPhase < 0.625) moonIcon = 'üåì';
			else if (moonPhase < 0.875) moonIcon = 'üåî';
			else moonIcon = 'üåï';

			moonPhaseSymbol.innerHTML = `<div style="color: darkblue;">${moonIcon}</div>`;
			container.appendChild(moonPhaseSymbol);
		}

		function fetchSunData(lat, lng) {
			sunMoonData = SunCalc.getTimes(getCurrentDate(), lat, lng);
			if (symbolsVisible) {
				createSunMoonSymbols(sunMoonData);
				updateWatchFaceGradient();
			}
		}

		function getFallbackLocation() {
			const lat = initialCoords[0];
			const lng = initialCoords[1];
			initMap(lat, lng);
			fetchSunData(lat, lng);
			fetchLocationName(lat, lng);
		}

		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(
					(position) => {
						const lat = position.coords.latitude;
						const lng = position.coords.longitude;
						initMap(lat, lng);
						fetchSunData(lat, lng);
						fetchLocationName(lat, lng);
					},
					(error) => {
						getFallbackLocation();
					}
				);
			} else {
				getFallbackLocation();
			}
		}

		function updateSunMoonLabel() {
			const label = document.getElementById('label-sun-moon');
			if (symbolsVisible && is24HourMode) {
				label.classList.add('active');
			} else {
				label.classList.remove('active');
			}
		}

		function toggleSunMoonSymbols() {
			symbolsVisible = !symbolsVisible;
			const debugControls = document.querySelector('.debug-controls');

			if (symbolsVisible) { // Activating
				debugControls.style.display = 'block';
				if (!map) {
					getLocation();
				} else {
					setTimeout(function() {
						map.invalidateSize();
					}, 10);
				}
				if (!is24HourMode) {
					timeModeBeforeSunMoon = '12h';
					toggleTimeMode();
				} else {
					const container = document.getElementById('sun-moon-symbols');
					if (sunMoonData) {
						createSunMoonSymbols(sunMoonData);
						updateWatchFaceGradient();
					} else {
						getLocation();
					}
					container.style.display = 'block';
					document.querySelector('.watch-face').classList.add('sun-moon-active');
				}
			} else { // Deactivating
				debugControls.style.display = 'none';
				document.getElementById('sun-moon-symbols').style.display = 'none';
				document.querySelector('.watch-face').classList.remove('sun-moon-active');
				if (timeModeBeforeSunMoon === '12h') {
					toggleTimeMode();
					timeModeBeforeSunMoon = null;
				}
			}
			updateSunMoonLabel();
		}

		// --- Mode Toggles ---
		function toggleMode() {
			body.classList.toggle('dark-mode');
			body.classList.toggle('light-mode');
			const isDarkMode = body.classList.contains('dark-mode');
			document.getElementById('label-dark').classList.toggle('active', isDarkMode);
			document.getElementById('label-light').classList.toggle('active', !isDarkMode);
			localStorage.setItem('watch-theme', isDarkMode ? 'dark' : 'light');
			updateWatchFaceGradient();
		}

		function toggleTimeMode() {
			is24HourMode = !is24HourMode;
			const watchFace = document.querySelector('.watch-face');

			if (!is24HourMode) {
				document.getElementById('sun-moon-symbols').style.display = 'none';
				watchFace.classList.remove('sun-moon-active'); // Ensure gradient is off in 12h mode
			} else {
				if (symbolsVisible) {
					document.getElementById('sun-moon-symbols').style.display = 'block';
					if (!sunMoonData) {
						getLocation();
					} else {
						createSunMoonSymbols(sunMoonData);
						updateWatchFaceGradient();
					}
					watchFace.classList.add('sun-moon-active'); // Ensure gradient is on in 24h mode if symbols are visible
				}
			}
			updateSunMoonLabel();
			localStorage.setItem('watch-time-mode', is24HourMode ? '24h' : '12h');
			document.getElementById('label-24h').classList.toggle('active', is24HourMode);
			document.getElementById('label-12h').classList.toggle('active', !is24HourMode);

			markersContainer.style.transition = 'opacity 0.25s ease-out';
			markersContainer.style.opacity = '0';
			setTimeout(() => {
				createMarkers();
				markersContainer.style.transition = 'opacity 0.25s ease-in';
				markersContainer.style.opacity = '1';
			}, 250);

			createHourNumbers();
			setDate();
		}

		// --- Load Preferences ---
		function loadTheme() {
			const savedTheme = localStorage.getItem('watch-theme');
			const isDarkMode = savedTheme === 'dark';
			body.classList.toggle('dark-mode', isDarkMode);
			body.classList.toggle('light-mode', !isDarkMode);
			document.getElementById('label-dark').classList.toggle('active', isDarkMode);
			document.getElementById('label-light').classList.toggle('active', !isDarkMode);
		}

		function loadTimeMode() {
			const savedTimeMode = localStorage.getItem('watch-time-mode');
			is24HourMode = savedTimeMode === '24h';
			document.getElementById('label-24h').classList.toggle('active', is24HourMode);
			document.getElementById('label-12h').classList.toggle('active', !is24HourMode);
		}

		function loadChronoState() {
			const wasRunning = localStorage.getItem('chrono-running') === 'true';
			if (wasRunning) {
				const startTime = parseInt(localStorage.getItem('chrono-startTime'), 10);
				if (startTime) {
					chronoSeconds = (Date.now() - startTime) / 1000;
					handleStartLap();
				}
			} else {
				chronoSeconds = parseFloat(localStorage.getItem('chrono-seconds')) || 0;
				if (chronoSeconds > 0) {
					const chronoDegrees = ((chronoSeconds % 60) / 60) * 360;
					chronoHand.style.transform = `translate(-50%, -100%) rotate(${chronoDegrees}deg)`;
					chronoNumber.textContent = formatSeconds(chronoSeconds);
				}
			}
			updateChronoLabels();
		}

		// --- Event Listeners ---
		startStopButton.addEventListener('click', handleStartLap);
		resetButton.addEventListener('click', handleStopReset);
		modeToggleButton.addEventListener('click', toggleMode);
		timeModeButton.addEventListener('click', toggleTimeMode);
		sunMoonToggleButton.addEventListener('click', toggleSunMoonSymbols);
		resetDebugButton.addEventListener('click', resetToNow);

		const today = new Date();
		const sixMonthsAgo = new Date(today);
		sixMonthsAgo.setMonth(today.getMonth() - 6);
		const sixMonthsHence = new Date(today);
		sixMonthsHence.setMonth(today.getMonth() + 6);

		const totalDays = Math.floor((sixMonthsHence - sixMonthsAgo) / (1000 * 60 * 60 * 24));
		const todayOffset = Math.floor((today - sixMonthsAgo) / (1000 * 60 * 60 * 24));

		dateSlider.addEventListener('input', (e) => {
			const selectedDayOffset = parseInt(e.target.value);
			debugDateOffset = selectedDayOffset - todayOffset;
			const newDate = getCurrentDate();
			dateValue.textContent = newDate.toLocaleDateString();
			setDate();
			if(marker) {
				const { lat, lng } = marker.getLatLng();
				fetchSunData(lat, lng);
			}
		});

		// --- Initialization ---
		document.getElementById('label-start').classList.add('active');
		loadTheme();
		loadTimeMode();
		createMarkers();
		createChronoMarkers();
		createHourNumbers();
		setDate();
		setInterval(setDate, 1000);
		loadChronoState();
		getLocation();

		dateSlider.min = 0;
		dateSlider.max = totalDays;
		dateSlider.value = todayOffset;
		dateValue.textContent = today.toLocaleDateString();

	</script>
</body>

</html>